name: å¿«é€Ÿæµ‹è¯•

# è§¦å‘æ¡ä»¶ - æ‰€æœ‰åˆ†æ”¯çš„æ¨é€å’ŒPR
on:
  push:
  pull_request:
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'
  QT_QPA_PLATFORM: offscreen

jobs:
  # å¿«é€Ÿæµ‹è¯•ä½œä¸š
  quick-test:
    name: å¿«é€Ÿæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0
        
    - name: ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: è¿è¡Œå¿«é€Ÿæµ‹è¯•
      run: |
        xvfb-run -a python run_tests.py --fast
        
    - name: åŸºç¡€ä»£ç æ£€æŸ¥
      run: |
        # æ£€æŸ¥Pythonè¯­æ³•
        python -m py_compile src/main.py
        
        # ç®€å•çš„ä»£ç é£æ ¼æ£€æŸ¥
        if command -v flake8 &> /dev/null; then
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        fi
      continue-on-error: true
        
    - name: æµ‹è¯•ç»“æœæ€»ç»“
      if: always()
      run: |
        echo "ğŸ¯ å¿«é€Ÿæµ‹è¯•å®Œæˆ"
        echo "ğŸ“Š æµ‹è¯•ç»“æœ: ${{ job.status }}"
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!"
        else
          echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi