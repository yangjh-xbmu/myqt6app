name: CI/CD Pipeline

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'
  QT_QPA_PLATFORM: offscreen  # ç”¨äºæ— å¤´ç¯å¢ƒè¿è¡ŒQtåº”ç”¨

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: ä»£ç æ ¼å¼æ£€æŸ¥ (Black)
      run: black --check --diff src/ tests/
      
    - name: å¯¼å…¥æ’åºæ£€æŸ¥ (isort)
      run: isort --check-only --diff src/ tests/
      
    - name: ä»£ç é£æ ¼æ£€æŸ¥ (Flake8)
      run: flake8 src/ tests/ --max-line-length=120 --ignore=E203,W503
      
    - name: ç±»å‹æ£€æŸ¥ (MyPy)
      run: mypy src/ --ignore-missing-imports
      continue-on-error: true  # ç±»å‹æ£€æŸ¥å¤±è´¥ä¸é˜»æ­¢æµæ°´çº¿

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
        
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0
        
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        xvfb-run -a python run_tests.py --unit --coverage
        
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0
        
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        xvfb-run -a python run_tests.py --integration

  # UIæµ‹è¯• (å¯é€‰ï¼Œå› ä¸ºåœ¨CIç¯å¢ƒä¸­è¿è¡ŒGUIæµ‹è¯•æ¯”è¾ƒå¤æ‚)
  ui-tests:
    name: UIæµ‹è¯•
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0
        
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: è¿è¡ŒUIæµ‹è¯•
      run: |
        xvfb-run -a python run_tests.py --ui
      continue-on-error: true  # UIæµ‹è¯•å¤±è´¥ä¸é˜»æ­¢æµæ°´çº¿

  # æ„å»ºå’Œæ‰“åŒ…
  build:
    name: æ„å»ºåº”ç”¨
    runs-on: ${{ matrix.os }}
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0
        
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/AppData/Local/pip/Cache
          ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      shell: bash
        
    - name: æ„å»ºåº”ç”¨
      run: |
        pyinstaller --onefile --windowed --name myqt6app src/main.py
      shell: bash
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: myqt6app-${{ matrix.os }}
        path: dist/

  # éƒ¨ç½² (ä»…åœ¨ä¸»åˆ†æ”¯)
  deploy:
    name: éƒ¨ç½²åº”ç”¨
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        path: artifacts/
        
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: artifacts/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬
        echo "âœ… éƒ¨ç½²å®Œæˆ!"